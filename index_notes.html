<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>sight singing</title>
  <link rel="stylesheet" href="static/main.css">
  <!-- TODO modules -->
</head>
<body>
  <header>Sight signing exercises</header>

  <section id="score1"></section>
  <section id="errors"></section>

  <section id="controls">
    <button id='start_btn' class='button'>Start</button>
    <button id='play_btn' class='button'>Play Line</button>
    <button id='prev_btn' class='button'>Previous Exercise</button>
    <button id='next_btn' class='button'>Next Exercise</button>
    <div id='message'></div>
  </section>

  <footer>
    <p>by David H.Friedman at <a href="http://www.fullstackacademy.com/">Fullstack Academy</a></p>
  </footer>
</body>
<script type="text/javascript" src="static/vexflow-min.js"></script>
<script type="text/javascript">
  try {
    const width = 700

    // boilerplate
    const VF = Vex.Flow
    const div = document.getElementById('score1')
    const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG)
    renderer.resize(2*width, 200)
    const context = renderer.getContext()

    // customize
    context.setFont('Arial', 10, '').setBackgroundFillStyle('#eed')

    // Staff
    const stave = new VF.Stave(10, 40, width)
    stave.addClef('treble').addTimeSignature('4/4')

    // render
    stave.setContext(context).draw()

    /* Create a voice in 4/4 and add notes
    var voice = new VF.Voice({num_beats: 4,  beat_value: 4});
    voice.addTickables([
      new VF.StaveNote({clef: "treble", keys: ["c/4"], duration: "q" }),
      new VF.StaveNote({clef: "treble", keys: ["d/4"], duration: "q" }),
      new VF.StaveNote({clef: "treble", keys: ["e/4"], duration: "q" }),
      new VF.StaveNote({clef: "treble", keys: ["f/4"], duration: "q" }),
    ])
    var formatter = new VF.Formatter().joinVoices([voice]).format([voice], width);
    // Render voice
    voice.draw(context, stave);
    */
    /*
    var notes = [
      new VF.StaveNote({clef: "treble", keys: ["c/5"], duration: "q" }),
      new VF.StaveNote({clef: "treble", keys: ["d/4"], duration: "q" }),
      new VF.StaveNote({clef: "treble", keys: ["b/4"], duration: "qr" }),
      new VF.StaveNote({clef: "treble", keys: ["c/4", "e/4", "g/4"], duration: "q" })
    ];

    var notes2 = [
      new VF.StaveNote({clef: "treble", keys: ["c/4"], duration: "w" })
    ];

    var voices = [
      new VF.Voice({num_beats: 4, beat_value: 4}).addTickables(notes),
      new VF.Voice({num_beats: 4, beat_value: 4}).addTickables(notes2)
    ];

    var formatter = new VF.Formatter().joinVoices(voices).format(voices, width);
    voices.forEach(function(v) { v.draw(context, stave) });
    */

    var notes = [
      new VF.StaveNote({clef: "treble", keys: ["d/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["f/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["e/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["d/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["g/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["f/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["a/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["g/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["f/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["e/4"], duration: "h" }),
      new VF.StaveNote({clef: "treble", keys: ["d/4"], duration: "w" }),
    ];

    /*var notes2 = [
      new VF.StaveNote({clef: "treble", keys: ["c/4"], duration: "w" })
    ];*/

    var voices = [
      new VF.Voice({num_beats: 12, beat_value: 2}).addTickables(notes),
      //new VF.Voice({num_beats: 4, beat_value: 4}).addTickables(notes2)
    ];

    var formatter = new VF.Formatter().joinVoices(voices).format(voices, width);
    voices.forEach(function(v) { v.draw(context, stave) });

/*
  console.log('render', renderer.elementId)
  let p = renderer.elementId.getElementsByTagName('svg')[0]
  console.log('p', p)
  let ns = p.getElementsByClassName('vf-stavenote')
  console.log('ns', ns)
  let first = p.getElementsByClassName('vf-stavenote')[0]
  console.log('first', first)
  let bbox = first.getBBox()
  console.log('bbox', bbox)
  console.log('moo', bbox.x, bbox.y, bbox.width, bbox.height)
*/

/*
  let notehead = first.getElementsByClassName('vf-notehead')[0]
  console.log('notehead', notehead)
  let path = first.getElementsByTagName('path')[0]
  console.log('notehead\'s path', path)
*/
  const xmlns = "http://www.w3.org/2000/svg"
  const rect = document.createElementNS(xmlns, "rect")
  rect.style.stroke = "blue"
  //rect.style['stroke-dasharray'] = "3,2,3"
  rect.style['stroke-width'] = 1
  rect.style['fill-opacity'] = 0

  /*
  console.log("next sib", ns[0].nextSibling)
  ns[0].parentNode.insertBefore(rect, ns[0].nextSibling)
  */
    highlightNote(notes[0], rect)


} catch (err) {
    errors.innerText = err
  }

  let cur_note = 0

  document.getElementById("next_btn").addEventListener("click", function() {
    if (++cur_note > notes.length) {
      cur_note = 0
    }
    highlightNote(notes[cur_note], rect)
});
document.getElementById("prev_btn").addEventListener("click", function() {
    if (--cur_note < 0) {
      cur_note = notes.length-1
    }
    highlightNote(notes[cur_note], rect)
});

  function highlightNote(note, rect) {
    rect.remove()
    let element = note.attrs.el
    console.log('note element', element)
    let bbox = element.getBBox()
    rect.setAttributeNS(null,"x",bbox.x-5)
    rect.setAttributeNS(null,"y",bbox.y-20)
    rect.setAttributeNS(null,"height",bbox.height+30)
    rect.setAttributeNS(null,"width",bbox.width+10)
    element.parentNode.insertBefore(rect, element.nextSibling)
  }
</script>
</html>